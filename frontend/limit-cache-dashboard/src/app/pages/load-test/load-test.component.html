<div class="load-test">
  <div class="page-header">
    <div>
      <h1 class="page-title">Load Test</h1>
      <p class="page-subtitle">Run performance tests against the limit service</p>
    </div>
  </div>

  @if (error) {
    <div class="alert alert-error">{{ error }}</div>
  }

  @if (running) {
    <div class="running-state">
      <div class="spinner-large"></div>
      <h3>Running Load Test...</h3>
      <p>Please wait while the test completes.</p>
    </div>
  } @else {
    <!-- <div class="card">
      <div class="card-header">
        <div class="card-title"><h3>Quick Tests</h3></div>
      </div>
      <div class="quick-actions">
        <button class="btn btn-primary" (click)="runQuickTest(true)">Quick Test (With Cache)</button>
        <button class="btn btn-secondary" (click)="runQuickTest(false)">Quick Test (Without Cache)</button>
      </div>
    </div> -->

    <div class="card">
      <div class="card-header">
        <div class="card-title"><h3>Custom Load Test</h3></div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Threads <i class="info-icon" data-tooltip="Number of concurrent threads sending requests simultaneously. More threads = higher contention on the same database row.">i</i></label>
          <input type="number" class="form-input" [(ngModel)]="threads" min="1" max="200">
        </div>
        <div class="form-group">
          <label>Total Requests <i class="info-icon" data-tooltip="Total number of limit-consume requests to execute. All threads share this workload. The test ends when all requests are processed.">i</i></label>
          <input type="number" class="form-input" [(ngModel)]="totalRequests" min="1000" max="1000000" step="1000">
        </div>
        <div class="form-group">
          <label>Use Cache <i class="info-icon" data-tooltip="Yes = requests go through Redis cache (fast). No = requests go directly to PostgreSQL (slower, shows DB contention).">i</i></label>
          <select class="form-input" [(ngModel)]="useCache">
            <option [ngValue]="true">Yes</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary run-btn" (click)="runLoadTest()">Run Load Test</button>
    </div>

    @if (result) {
      <div class="card">
        <div class="card-header">
          <div class="card-title"><h3>Results</h3></div>
          <span class="mode-badge" [class.cache]="result.mode === 'CACHE_ENABLED'">{{ result.mode }}</span>
        </div>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Total Requests</div>
            <div class="metric-value">{{ result.totalRequests | number }}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Successful</div>
            <div class="metric-value success">{{ result.successfulRequests | number }}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Failed</div>
            <div class="metric-value" [class.error]="result.failedRequests > 0">{{ result.failedRequests | number }}</div>
          </div>
          <div class="metric-card highlight-metric">
            <div class="metric-label">Time Taken <i class="info-icon" data-tooltip="Total wall-clock time to complete all requests. Lower means faster processing.">i</i></div>
            <div class="metric-value">{{ result.durationMs | number }} <small>ms</small></div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Throughput <i class="info-icon" data-tooltip="Transactions Per Second — how many requests were completed per second on average.">i</i></div>
            <div class="metric-value">{{ result.throughputTps | number:'1.0-0' }} <small>TPS</small></div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Avg Latency <i class="info-icon" data-tooltip="Average time for a single request to complete, measured from send to response.">i</i></div>
            <div class="metric-value">{{ result.avgLatencyMs | number:'1.2-2' }} <small>ms</small></div>
          </div>
          <div class="metric-card">
            <div class="metric-label">P99 Latency <i class="info-icon" data-tooltip="99th percentile latency — 99% of requests completed within this time. Shows worst-case behavior.">i</i></div>
            <div class="metric-value">{{ result.p99LatencyMs | number:'1.2-2' }} <small>ms</small></div>
          </div>
        </div>
      </div>
    }

    @if (history.length > 0) {
      <div class="card">
        <div class="card-header">
          <div class="card-title"><h3>Test History</h3></div>
        </div>
        <div class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Mode</th>
                <th>Threads</th>
                <th>Requests</th>
                <th>Success</th>
                <th>Time Taken</th>
                <th>TPS</th>
                <th>Avg Latency</th>
              </tr>
            </thead>
            <tbody>
              @for (item of history; track item.id) {
                <tr>
                  <td>{{ item.createdAt | date:'short' }}</td>
                  <td><span class="mode-badge small" [class.cache]="item.mode === 'CACHE_ENABLED'">{{ item.mode }}</span></td>
                  <td>{{ item.threads }}</td>
                  <td>{{ item.totalRequests | number }}</td>
                  <td>{{ item.successfulRequests | number }}</td>
                  <td>{{ item.durationMs | number }} ms</td>
                  <td>{{ item.throughputTps | number:'1.1-1' }}</td>
                  <td>{{ item.avgLatencyMs | number:'1.2-2' }} ms</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  }
</div>
